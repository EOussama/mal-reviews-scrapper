<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    textarea {
      width: 100%;
      height: 300px;
    }

    summary {
      cursor: pointer;

      display: flex;
      flex-direction: row;

      color: grey;
    }

    summary:hover {
      background-color: whitesmoke;
    }

    h4 {
      margin: 0;
      color: black;
    }

    summary>* {
      margin-right: 10px;
    }
  </style>

  <title>MAL Reviews Scrapper</title>
</head>

<body>
  <h1>MAL Reviews Scrapper</h1>
  <hr>

  <p>Created for my personal archiving needs.</p>
  <ol id="reviews"></ol>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const cache = await loadCache();
      const fileNames = await loadFileNames();
      const reviews = await loadReviews(fileNames);
      const reviewsElement = document.getElementById('reviews');

      for (const review of reviews) {
        const reviewElement = document.createElement('li');
        const reviewDetails = document.createElement('details');
        const reviewSummary = document.createElement('summary');
        const reviewTextArea = document.createElement('textarea');
        const reviewTitle = document.createElement('h4');
        const reviewRating = document.createElement('span');
        const reviewDate = document.createElement('span');
        const reviewLink = document.createElement('a');
        const reviewId = document.createElement('span');

        reviewTextArea.value = review.content;
        reviewTextArea.setAttribute('readonly', true);

        reviewLink.textContent = review.title;
        reviewLink.setAttribute('href', review.url);

        reviewId.textContent = `[${review.id}]`;
        reviewDate.textContent = `${review.date} ${review.time}`;
        reviewRating.textContent = `${review.rating}/10 [${review.recommendation}]`;

        reviewTitle.append(reviewLink);
        reviewSummary.append(reviewId);
        reviewSummary.append(reviewTitle);
        reviewSummary.append(reviewRating);
        reviewSummary.append(reviewDate);

        reviewDetails.append(reviewTextArea);
        reviewDetails.append(reviewSummary);
        reviewElement.append(reviewDetails);
        reviewsElement.append(reviewElement);
      }

      async function loadCache() {
        const cacheTimestamp = '2024-02-14-12-04-47';
        const cache = await fetch(`assets/cache/cache-${cacheTimestamp}.json`).then(e => e.json());
        return cache;
      }

      async function loadFileNames() {
        const reviewsCSV = await fetch('assets/reviews.csv').then(e => e.text());
        const reviewFileNames = reviewsCSV.split(',').map(e => e.substr(e.indexOf('assets/')));

        return reviewFileNames;
      }

      async function loadReviews(fileNames) {
        const reviewFiles = await Promise.all(fileNames.filter(e => e.endsWith('.json')).map(e => fetch(e).then(e => e.json())));
        const reviews = reviewFiles.sort((a, b) => new Date(a.date) - new Date(b.date));

        return reviews;
      }
    });
  </script>
</body>

</html>